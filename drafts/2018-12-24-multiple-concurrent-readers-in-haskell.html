<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" content="text/html" http-equiv="content-type" />
    <meta content="Alfredo Di Napoli - Computer Scientist, Scala and Haskell Programmer" name="title" />
    <meta content="Alfredo Di Napoli - Computer Scientist, Scala and Haskell Programmer" name="description" />
    <meta content="Alfredo Di Napoli, Di Napoli Alfredo, Haskell, C++, Python, Scala
    Programmer, Engineer, Functional, Programmatore, Roma, Web" name="keywords" />
    <meta content="alfredo.dinapoli@gmail.com" name="Author" /><meta content="global" name="distribution" />
    <meta content="document" name="resource-type" /><meta content="Alfredo Di Napoli" name="CreatedBy" />
    <meta content="General" name="RATING" />
    <meta content="all,index,follow" name="ROBOTS" />
    <meta content="15 days" name="REVISIT-AFTER" />
    <meta content="Public" name="document-type" />
    <meta content="Safe for Kids" name="document-rating" />
    <meta content="Global" name="document-distribution" />
    <meta content="internet" name="document-classification" />
    <meta content="Alfredo Di Napoli - Computer Scientist, Scala and Haskell Programmer" name="abstract" />
    <meta content="en" http-equiv="content-language" />
    <meta content="Aladin" name="robots" />
    <meta content="scooter" name="robots" />
    <meta content="Crawler" name="robots" />
    <meta content="Eule-Robot" name="robots" />
    <meta content="excite" name="robots" />
    <meta content="Flipper/1.1" name="robots" />
    <meta content="SmartCrawl" name="robots" />
    <meta content="Motor0.5" name="robots" />
    <meta content="Lycos" name="robots" />
    <meta content="Google" name="robots" />
    <meta content="Bing" name="robots" />
    <meta content="Copyright &copy; Alfredo Di Napoli - All rights reserved" name="copyright" />
    <meta content="web design, functional, haskell, scala, python, programming" name="classification" />
    <meta content="GLOBAL" name="distribution" />

    <title>Alfredo Di Napoli - Computer Scientist, Scala and Haskell Programmer</title>
    <link href="../css/bootstrap.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="../css/syntax.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="../css/screen.css" rel="stylesheet" type="text/css" media="screen" />
    
  </head>

  <body>
    <div class="container">
      
      <!-- start header -->
      <div id="header" class="row">

        <div class="col-5">
          <div class="col-7">
            <em class="lead">Simplicity is the ultimate sophistication.</em>
          </div>

          <div class="col-5 pull-left">
            <img src="../img/enso.png" width="100" />
          </div>
        </div>
        
        <div class="col-7">
          <div id="menu" class="pull-right">
            <a href="../index.html">Home</a> ●
            <a href="../posts.html">Blog</a> ●
            <a href="../oss.html">Projects</a> ●
            <a href="../talks.html">Talks</a> ●
            <a href="../cv_eu/cv_eu.html">CV</a> ●
            <a href="../contacts.html">Contacts</a>
          </div>
        </div>

      </div>

      <!-- end header -->
      <div class="row">
        <hr>
          <!-- content goes here -->
          <script type="text/javascript">
  var disqus_developer = 1;
</script>


<h1>Multiple concurrent file readers in Haskell</h1>

<p>Posted in: <a title="All pages tagged 'haskell'." href="../tags/haskell.html">haskell</a>.</p>
<br>
<p><em>This is a Literate Haskell post. You can download and play with it in the editor.</em></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE BangPatterns        #-}</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE RecordWildCards     #-}</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE ScopedTypeVariables #-}</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE TupleSections       #-}</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Main</span> (</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">HandleManager</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    , newEmptyHandleManager</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    , closeHandleManager</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    , <span class="dt">ReadHandle</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    , <span class="dt">WriteHandle</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    , openDBFile</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    , closeDBFile</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    , openReadHandle</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    , closeWriteHandle</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    , writeToHandle</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    , readFromHandle</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    , readHandleAbsoluteSeek</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- * Testing only</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    , demo</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    ) <span class="kw">where</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Control.Exception</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Control.Monad</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Control.Monad.Except</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Control.Monad.Reader</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.ByteString</span> (<span class="dt">ByteString</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.ByteString.Builder</span> (<span class="dt">Builder</span>)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Builder</span> <span class="kw">as</span> <span class="dt">BL</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Char8</span> <span class="kw">as</span> <span class="dt">C8</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Map</span> (<span class="dt">Map</span>)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map</span> <span class="kw">as</span> <span class="dt">Map</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.Word</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">System.Random</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">GHC.Stack</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Ouroboros.Network.MonadClass</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Ouroboros.Storage.Immutable.FS</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="co">-- crucial question: is complexity in this layer (by having lifetime maangement</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="co">-- our side) worth it? if not, how do we stop readers from blocking slot</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="co">-- writing?</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">HandleState</span> m <span class="ot">=</span> <span class="dt">HS</span> {</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="ot">      hsReadHandles  ::</span> <span class="op">!</span>(<span class="dt">Map</span> <span class="dt">FsPath</span> [<span class="dt">ReadHandle</span> m])</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    ,<span class="ot"> hsWriteHandles ::</span> <span class="op">!</span>(<span class="dt">Map</span> <span class="dt">FsPath</span> (<span class="dt">WriteHandle</span> m))</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="co">-- | An opaque reference to a 'FsHandle' \&quot;manager\&quot;. Such manager is</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="co">-- responsible for the lifetime management of the underlying handles, and</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a><span class="co">-- most importantly is capable of \&quot;suspending\&quot; and resuming them in a way</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="co">-- that allows concurrent reads and writes to happen on the same shared</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="co">-- resource.</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">HandleManager</span> m <span class="ot">=</span> <span class="dt">HandleManager</span> {</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="ot">      im ::</span> <span class="op">!</span>(<span class="dt">TMVar</span> m (<span class="dt">HandleState</span> m))</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Creates a new, empty 'HandleManager'.</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a><span class="ot">newEmptyHandleManager ::</span> <span class="dt">MonadSTM</span> m <span class="ot">=&gt;</span> m (<span class="dt">HandleManager</span> m)</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>newEmptyHandleManager <span class="ot">=</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    <span class="dt">HandleManager</span> <span class="op">&lt;$&gt;</span> atomically (newTMVar (<span class="dt">HS</span> <span class="fu">mempty</span> <span class="fu">mempty</span>))</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Closes the 'HandleManager', closing all the associated handlers it</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="co">-- manages. You want to typically call this function only once at the end</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a><span class="co">-- of your program.</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="ot">closeHandleManager ::</span> <span class="dt">HasFS</span> m <span class="ot">=&gt;</span> <span class="dt">HandleManager</span> m <span class="ot">-&gt;</span> m ()</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>closeHandleManager <span class="dt">HandleManager</span>{<span class="op">..</span>} <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>    hs<span class="op">@</span><span class="dt">HS</span>{<span class="op">..</span>} <span class="ot">&lt;-</span> atomically <span class="op">$</span> takeTMVar im</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> allReaders <span class="ot">=</span> Map.toList hsReadHandles</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> allWriters <span class="ot">=</span> Map.toList hsWriteHandles</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>    forM_ allReaders <span class="op">$</span> \(_, rws) <span class="ot">-&gt;</span> forM_ rws <span class="op">$</span> \(<span class="dt">RH</span> _ r) <span class="ot">-&gt;</span> closeHandleRef r</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>    forM_ allWriters <span class="op">$</span> \(_, (<span class="dt">WH</span> _ w)) <span class="ot">-&gt;</span> closeHandleRef w</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    atomically <span class="op">$</span> putTMVar im (hs { hsWriteHandles <span class="ot">=</span> <span class="fu">mempty</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>                                 , hsReadHandles  <span class="ot">=</span> <span class="fu">mempty</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>                             })</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Opaque references to read &amp; write handles.</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a><span class="co">-- could extend this so that all readers of the same epoch share a reference</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a><span class="co">-- an an index, so that as soon as one reader reads the entire index of the</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a><span class="co">-- epoch, all readers immediately have access to it.</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a><span class="co">-- we can decide when to read the index (or even allow the user to indicate</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a><span class="co">-- whether it would be useful)</span></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">ReadHandle</span> m <span class="ot">=</span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>    <span class="dt">RH</span> <span class="dt">FsPath</span> (<span class="dt">TMVar</span> m (<span class="dt">Either</span> (<span class="dt">FsHandle</span> m, <span class="dt">Word64</span>) <span class="dt">Word64</span>))</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">WriteHandle</span> m <span class="ot">=</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>    <span class="dt">WH</span> <span class="dt">FsPath</span> (<span class="dt">TMVar</span> m (<span class="dt">Either</span> (<span class="dt">FsHandle</span> m, <span class="dt">Word64</span>) <span class="dt">Word64</span>))</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Opens a DB file, returning the (one and only) 'WriteHandle'. This is</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a><span class="co">-- by design; this is the /only/ way to acquire a 'WriteHandle'. When we close</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a><span class="co">-- the relevant file in 'closeDbFile', we also close any associated 'WriteHandle'.</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a><span class="ot">openDBFile ::</span> <span class="dt">HasFS</span> m <span class="ot">=&gt;</span> <span class="dt">HandleManager</span> m <span class="ot">-&gt;</span> <span class="dt">FsPath</span> <span class="ot">-&gt;</span> m (<span class="dt">WriteHandle</span> m)</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>openDBFile <span class="dt">HandleManager</span>{<span class="op">..</span>} fp <span class="ot">=</span> atomically <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>    hs<span class="op">@</span><span class="dt">HS</span>{<span class="op">..</span>} <span class="ot">&lt;-</span> takeTMVar im</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>    wh <span class="ot">&lt;-</span> <span class="kw">case</span> Map.lookup fp hsWriteHandles <span class="kw">of</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Just</span> _  <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;you cannot open more than 1 writehandle per file.&quot;</span></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>        <span class="dt">WH</span> fp <span class="op">&lt;$&gt;</span> newTMVar (<span class="dt">Right</span> <span class="dv">0</span>)</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>    putTMVar im (hs { hsWriteHandles <span class="ot">=</span> Map.insert fp wh hsWriteHandles })</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> wh</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Closes the DB file.</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a><span class="co">-- </span><span class="al">NOTE</span><span class="co">(adn): the choice here is to abruptly close the write handle or to wait</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a><span class="co">-- for the write to finish, which might delay closing the DB.</span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a><span class="ot">closeDBFile ::</span> <span class="kw">forall</span> m<span class="op">.</span> (<span class="dt">HasCallStack</span>, <span class="dt">HasFS</span> m)</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>            <span class="ot">=&gt;</span> <span class="dt">HandleManager</span> m</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>            <span class="ot">-&gt;</span> <span class="dt">FsPath</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>            <span class="ot">-&gt;</span> m (<span class="dt">Either</span> <span class="dt">FsError</span> ())</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>closeDBFile <span class="dt">HandleManager</span>{<span class="op">..</span>} fp <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>    hs<span class="op">@</span><span class="dt">HS</span>{<span class="op">..</span>} <span class="ot">&lt;-</span> atomically <span class="op">$</span> takeTMVar im</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">&lt;-</span> runExceptT <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>        <span class="kw">case</span> Map.lookup fp hsReadHandles <span class="kw">of</span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>             <span class="dt">Nothing</span>  <span class="ot">-&gt;</span> <span class="fu">return</span> ()</span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>             <span class="dt">Just</span> rhs <span class="ot">-&gt;</span> forM_ rhs <span class="op">$</span> \(<span class="dt">RH</span> _ mv) <span class="ot">-&gt;</span> <span class="dt">ExceptT</span> <span class="op">$</span> closeHandleRef mv</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>        <span class="kw">case</span> Map.lookup fp hsWriteHandles <span class="kw">of</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>             <span class="dt">Nothing</span>        <span class="ot">-&gt;</span> <span class="fu">return</span> ()</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>             <span class="dt">Just</span> (<span class="dt">WH</span> _ mv) <span class="ot">-&gt;</span> <span class="dt">ExceptT</span> <span class="op">$</span> closeHandleRef mv</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>    atomically (putTMVar im hs)</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> r</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Internal utility function to close a handle.</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a><span class="ot">closeHandleRef ::</span> (<span class="dt">HasCallStack</span>, <span class="dt">HasFS</span> m)</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>               <span class="ot">=&gt;</span> <span class="dt">TMVar</span> m (<span class="dt">Either</span> (<span class="dt">FsHandle</span> m, <span class="dt">Word64</span>) <span class="dt">Word64</span>)</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>               <span class="ot">-&gt;</span> m (<span class="dt">Either</span> <span class="dt">FsError</span> ())</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>closeHandleRef mv <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>    wh <span class="ot">&lt;-</span> atomically <span class="op">$</span> takeTMVar mv</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">&lt;-</span> runExceptT <span class="op">$</span> <span class="kw">case</span> wh <span class="kw">of</span></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Right</span> _     <span class="ot">-&gt;</span> <span class="fu">return</span> ()</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Left</span>  (h,_) <span class="ot">-&gt;</span> <span class="dt">ExceptT</span> <span class="op">$</span> hClose h</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>    atomically (putTMVar mv wh)</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> r</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a><span class="ot">openReadHandle ::</span> <span class="kw">forall</span> m<span class="op">.</span> <span class="dt">HasFS</span> m</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>               <span class="ot">=&gt;</span> <span class="dt">HandleManager</span> m</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>               <span class="ot">-&gt;</span> <span class="dt">FsPath</span></span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>               <span class="ot">-&gt;</span> m (<span class="dt">ReadHandle</span> m)</span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>openReadHandle <span class="dt">HandleManager</span>{<span class="op">..</span>} fp <span class="ot">=</span> atomically <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>    hs<span class="op">@</span><span class="dt">HS</span>{<span class="op">..</span>} <span class="ot">&lt;-</span> takeTMVar im</span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>    rh <span class="ot">&lt;-</span> <span class="dt">RH</span> fp <span class="op">&lt;$&gt;</span> newTMVar (<span class="dt">Right</span> <span class="dv">0</span>)</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span><span class="ot"> aux ::</span> <span class="dt">Maybe</span> [<span class="dt">ReadHandle</span> m] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> [<span class="dt">ReadHandle</span> m]</span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>        aux <span class="dt">Nothing</span>    <span class="ot">=</span> <span class="dt">Just</span> [rh]</span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>        aux (<span class="dt">Just</span> dhs) <span class="ot">=</span> <span class="dt">Just</span> (rh <span class="op">:</span> dhs)</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>    putTMVar im (hs { hsReadHandles <span class="ot">=</span> Map.alter aux fp hsReadHandles })</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> rh</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Closes a previously-opened 'WriteHandle'.</span></span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a><span class="co">-- </span><span class="al">NOTE</span><span class="co">(adn): Here we are suppressing any internal error coming from closing</span></span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a><span class="co">-- the handles, but in future we might rethink this in case we do want to</span></span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a><span class="co">-- gracefully handle those failures.</span></span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a><span class="ot">closeWriteHandle ::</span> <span class="dt">HasFS</span> m <span class="ot">=&gt;</span> <span class="dt">HandleManager</span> m <span class="ot">-&gt;</span> <span class="dt">WriteHandle</span> m <span class="ot">-&gt;</span> m ()</span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>closeWriteHandle <span class="dt">HandleManager</span>{<span class="op">..</span>} (<span class="dt">WH</span> fp _) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>    hs<span class="op">@</span><span class="dt">HS</span>{<span class="op">..</span>} <span class="ot">&lt;-</span> atomically <span class="op">$</span> takeTMVar im</span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>    hs' <span class="ot">&lt;-</span> <span class="kw">case</span> Map.lookup fp hsWriteHandles <span class="kw">of</span></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>                <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> hs</span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>                <span class="dt">Just</span> (<span class="dt">WH</span> f mv) <span class="ot">-&gt;</span> assert (f <span class="op">==</span> fp) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>                    _ <span class="ot">&lt;-</span> void <span class="op">&lt;$&gt;</span> closeHandleRef mv</span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">return</span> (hs { hsWriteHandles <span class="ot">=</span> Map.delete fp hsWriteHandles })</span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>    atomically <span class="op">$</span> putTMVar im hs'</span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Internal function, used when we need to write to a file</span></span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a><span class="co">-- </span><span class="al">NOTE</span><span class="co">(adn): Here we are suppressing any internal error coming from closing</span></span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a><span class="co">-- the handles, but in future we might rethink this in case we do want to</span></span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a><span class="co">-- gracefully handle those failures.</span></span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a><span class="ot">withClosedReadHandles ::</span> <span class="dt">HasFS</span> m</span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>                      <span class="ot">=&gt;</span> <span class="dt">HandleManager</span> m</span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>                      <span class="ot">-&gt;</span> <span class="dt">FsPath</span></span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>                      <span class="ot">-&gt;</span> m a</span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>                      <span class="ot">-&gt;</span> m a</span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>withClosedReadHandles <span class="dt">HandleManager</span>{<span class="op">..</span>} fp action <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>    hs<span class="op">@</span><span class="dt">HS</span>{<span class="op">..</span>} <span class="ot">&lt;-</span> atomically <span class="op">$</span> takeTMVar im</span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> Map.lookup fp hsReadHandles <span class="kw">of</span></span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>         <span class="dt">Nothing</span> <span class="ot">-&gt;</span> atomically (putTMVar im hs) <span class="op">&gt;&gt;</span> action</span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a>         <span class="dt">Just</span> dhs <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>             forM_ dhs <span class="op">$</span> \(<span class="dt">RH</span> fp1 mv) <span class="ot">-&gt;</span> assert (fp <span class="op">==</span> fp1) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>                 <span class="co">-- This modifyMVar might temporarily block, but /we/ control how long that</span></span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>                 <span class="co">-- can be (in 'readFromHandle')</span></span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>                 rh <span class="ot">&lt;-</span> atomically <span class="op">$</span> takeTMVar mv</span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>                 rh' <span class="ot">&lt;-</span> <span class="kw">case</span> rh <span class="kw">of</span></span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>                   <span class="dt">Right</span> i <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">Right</span> i</span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>                   <span class="dt">Left</span>  (h,i)       <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>                     _ <span class="ot">&lt;-</span> hClose h</span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">return</span> <span class="op">$</span> <span class="dt">Right</span> i</span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>                 atomically <span class="op">$</span> putTMVar mv rh'</span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a>             atomically (putTMVar im hs) <span class="op">&gt;&gt;</span> action</span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Seek on a 'ReadHandle', to support random-access reads.</span></span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a><span class="ot">readHandleAbsoluteSeek ::</span> (<span class="dt">HasFS</span> m, <span class="dt">HasCallStack</span>)</span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>                       <span class="ot">=&gt;</span> <span class="dt">ReadHandle</span> m</span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>                       <span class="ot">-&gt;</span> <span class="dt">Word64</span></span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>                       <span class="ot">-&gt;</span> m (<span class="dt">Either</span> <span class="dt">FsError</span> ())</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>readHandleAbsoluteSeek (<span class="dt">RH</span> _ mv) <span class="op">!</span>n <span class="ot">=</span> runExceptT <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a>    rh <span class="ot">&lt;-</span> atomically <span class="op">$</span> takeTMVar mv</span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>    rh' <span class="ot">&lt;-</span> <span class="kw">case</span> rh <span class="kw">of</span></span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a>             <span class="dt">Left</span> (h,_)  <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a>                 <span class="dt">ExceptT</span> <span class="op">$</span> hSeek h <span class="dt">AbsoluteSeek</span> n</span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">return</span> <span class="op">$</span> <span class="dt">Left</span> (h, n)</span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a>             <span class="dt">Right</span> _ <span class="ot">-&gt;</span> <span class="fu">return</span> (<span class="dt">Right</span> n)</span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a>    atomically <span class="op">$</span> putTMVar mv rh'</span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Low-level (but public) streaming read API.</span></span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a><span class="ot">readFromHandle ::</span> <span class="dt">HasFS</span> m</span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>               <span class="ot">=&gt;</span> <span class="dt">HandleManager</span> m</span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a>               <span class="ot">-&gt;</span> <span class="dt">ReadHandle</span> m</span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a>               <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a>               <span class="ot">-&gt;</span> m (<span class="dt">Either</span> <span class="dt">FsError</span> <span class="dt">ByteString</span>)</span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a>readFromHandle <span class="dt">HandleManager</span>{<span class="op">..</span>} (<span class="dt">RH</span> fp mv1) <span class="op">!</span>n <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>    hs<span class="op">@</span><span class="dt">HS</span>{<span class="op">..</span>} <span class="ot">&lt;-</span> atomically <span class="op">$</span> takeTMVar im</span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>    bytes <span class="ot">&lt;-</span> <span class="kw">case</span> Map.lookup fp hsWriteHandles <span class="kw">of</span></span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> runExceptT <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a>            rh <span class="ot">&lt;-</span> atomically <span class="op">$</span> takeTMVar mv1</span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a>            (rh', bytes) <span class="ot">&lt;-</span> <span class="kw">case</span> rh <span class="kw">of</span></span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a>              <span class="dt">Left</span> p  <span class="ot">-&gt;</span> <span class="fu">uncurry</span> readNext p</span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a>              <span class="dt">Right</span> <span class="op">!</span>i<span class="ot">-&gt;</span> openAndReadNext i</span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>            atomically <span class="op">$</span> putTMVar mv1 rh'</span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span> bytes</span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> (<span class="dt">WH</span> _ mv2) <span class="ot">-&gt;</span> runExceptT <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a>            (rh, wh) <span class="ot">&lt;-</span> atomically <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>                readLock  <span class="ot">&lt;-</span> takeTMVar mv1</span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a>                writeLock <span class="ot">&lt;-</span> takeTMVar mv2</span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a>                <span class="fu">return</span> (readLock, writeLock)</span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a>            (wh', (rh', bytes)) <span class="ot">&lt;-</span> <span class="kw">case</span> rh <span class="kw">of</span></span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a>              <span class="dt">Left</span> p  <span class="ot">-&gt;</span> (,) <span class="op">&lt;$&gt;</span>               <span class="fu">pure</span> wh <span class="op">&lt;*&gt;</span> <span class="fu">uncurry</span> readNext p</span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a>              <span class="dt">Right</span> i <span class="ot">-&gt;</span> (,) <span class="op">&lt;$&gt;</span> suspendWriteHandle wh <span class="op">&lt;*&gt;</span> openAndReadNext i</span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a>            atomically <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>                putTMVar mv1 rh'</span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>                putTMVar mv2 wh'</span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span> bytes</span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>    atomically <span class="op">$</span> putTMVar im hs</span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> bytes</span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span></span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a><span class="ot">        openAndReadNext ::</span> <span class="dt">HasFS</span> m</span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>                        <span class="ot">=&gt;</span> <span class="dt">Word64</span></span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a>                        <span class="ot">-&gt;</span> <span class="dt">ExceptT</span> <span class="dt">FsError</span> m (<span class="dt">Either</span> (<span class="dt">FsHandle</span> m, <span class="dt">Word64</span>) <span class="dt">Word64</span>, <span class="dt">ByteString</span>)</span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a>        openAndReadNext i <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a>           rh' <span class="ot">&lt;-</span> <span class="dt">ExceptT</span> <span class="op">$</span> hOpen fp <span class="dt">ReadMode</span></span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a>           <span class="dt">ExceptT</span> <span class="op">$</span> hSeek rh' <span class="dt">AbsoluteSeek</span> i</span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a>           readNext rh' i</span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a><span class="ot">        readNext ::</span> <span class="dt">HasFS</span> m</span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a>                 <span class="ot">=&gt;</span> <span class="dt">FsHandle</span> m</span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a>                 <span class="ot">-&gt;</span> <span class="dt">Word64</span></span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>                 <span class="ot">-&gt;</span> <span class="dt">ExceptT</span> <span class="dt">FsError</span> m (<span class="dt">Either</span> (<span class="dt">FsHandle</span> m, <span class="dt">Word64</span>) <span class="dt">Word64</span>, <span class="dt">ByteString</span>)</span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a>        readNext h acc <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a>            bytes <span class="ot">&lt;-</span> <span class="dt">ExceptT</span> <span class="op">$</span> hGet h n</span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span> (<span class="dt">Left</span> (h, (acc <span class="op">+</span> <span class="fu">toEnum</span> n)), bytes)</span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a><span class="ot">        suspendWriteHandle ::</span> <span class="dt">HasFS</span> m</span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a>                           <span class="ot">=&gt;</span> <span class="dt">Either</span> (<span class="dt">FsHandle</span> m, <span class="dt">Word64</span>) <span class="dt">Word64</span></span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true" tabindex="-1"></a>                           <span class="ot">-&gt;</span> <span class="dt">ExceptT</span> <span class="dt">FsError</span> m (<span class="dt">Either</span> (<span class="dt">FsHandle</span> m, <span class="dt">Word64</span>) <span class="dt">Word64</span>)</span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true" tabindex="-1"></a>        suspendWriteHandle (<span class="dt">Right</span> r)    <span class="ot">=</span> <span class="fu">return</span> (<span class="dt">Right</span> r)</span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true" tabindex="-1"></a>        suspendWriteHandle (<span class="dt">Left</span> (h,i)) <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true" tabindex="-1"></a>            <span class="dt">ExceptT</span> <span class="op">$</span> hClose h</span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>  <span class="op">$</span> <span class="dt">Right</span> i</span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true" tabindex="-1"></a><span class="co">-- | Low-level (but public) streaming write API</span></span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true" tabindex="-1"></a><span class="ot">writeToHandle ::</span> <span class="dt">HasFS</span> m</span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true" tabindex="-1"></a>              <span class="ot">=&gt;</span> <span class="dt">HandleManager</span> m</span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true" tabindex="-1"></a>              <span class="ot">-&gt;</span> <span class="dt">WriteHandle</span> m</span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true" tabindex="-1"></a>              <span class="ot">-&gt;</span> <span class="dt">Builder</span></span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true" tabindex="-1"></a>              <span class="ot">-&gt;</span> m (<span class="dt">Either</span> <span class="dt">FsError</span> <span class="dt">Word64</span>)</span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true" tabindex="-1"></a>writeToHandle im (<span class="dt">WH</span> fp mv) bs <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true" tabindex="-1"></a>    withClosedReadHandles im fp <span class="op">$</span> runExceptT <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true" tabindex="-1"></a>        wh <span class="ot">&lt;-</span> atomically <span class="op">$</span> takeTMVar mv</span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true" tabindex="-1"></a>        (wh', bytesWritten) <span class="ot">&lt;-</span> <span class="kw">case</span> wh <span class="kw">of</span></span>
<span id="cb1-275"><a href="#cb1-275" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Left</span> (h,<span class="op">!</span>acc) <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb1-276"><a href="#cb1-276" aria-hidden="true" tabindex="-1"></a>              bytesWritten <span class="ot">&lt;-</span> <span class="dt">ExceptT</span> <span class="op">$</span> hPut h bs</span>
<span id="cb1-277"><a href="#cb1-277" aria-hidden="true" tabindex="-1"></a>              <span class="fu">return</span> (<span class="dt">Left</span> (h, acc <span class="op">+</span> bytesWritten), bytesWritten)</span>
<span id="cb1-278"><a href="#cb1-278" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Right</span> <span class="op">!</span>i <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb1-279"><a href="#cb1-279" aria-hidden="true" tabindex="-1"></a>            h <span class="ot">&lt;-</span> <span class="dt">ExceptT</span> <span class="op">$</span> hOpen fp <span class="dt">ReadWriteMode</span></span>
<span id="cb1-280"><a href="#cb1-280" aria-hidden="true" tabindex="-1"></a>            <span class="dt">ExceptT</span> <span class="op">$</span> hSeek h <span class="dt">AbsoluteSeek</span> i</span>
<span id="cb1-281"><a href="#cb1-281" aria-hidden="true" tabindex="-1"></a>            bytesWritten <span class="ot">&lt;-</span> <span class="dt">ExceptT</span> <span class="op">$</span> hPut h bs</span>
<span id="cb1-282"><a href="#cb1-282" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span> (<span class="dt">Left</span> (h, i <span class="op">+</span> bytesWritten), bytesWritten)</span>
<span id="cb1-283"><a href="#cb1-283" aria-hidden="true" tabindex="-1"></a>        atomically <span class="op">$</span> putTMVar mv wh'</span>
<span id="cb1-284"><a href="#cb1-284" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span> bytesWritten</span>
<span id="cb1-285"><a href="#cb1-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-286"><a href="#cb1-286" aria-hidden="true" tabindex="-1"></a><span class="co">-- We spawn 10 readers and 1 writer and we see what happens.</span></span>
<span id="cb1-287"><a href="#cb1-287" aria-hidden="true" tabindex="-1"></a><span class="ot">demo ::</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">FsError</span> ())</span>
<span id="cb1-288"><a href="#cb1-288" aria-hidden="true" tabindex="-1"></a>demo <span class="ot">=</span> <span class="fu">flip</span> runReaderT <span class="st">&quot;/var/tmp/&quot;</span> <span class="op">$</span> runExceptT <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-289"><a href="#cb1-289" aria-hidden="true" tabindex="-1"></a>    loggerLock <span class="ot">&lt;-</span> atomically <span class="op">$</span> newTMVar ()</span>
<span id="cb1-290"><a href="#cb1-290" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Preparation</span></span>
<span id="cb1-291"><a href="#cb1-291" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ExceptT</span> <span class="op">$</span> withFile [<span class="st">&quot;test.txt&quot;</span>] <span class="dt">WriteMode</span> <span class="op">$</span> \hdl <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb1-292"><a href="#cb1-292" aria-hidden="true" tabindex="-1"></a>        forM_ [<span class="dv">1</span><span class="op">..</span><span class="dv">255</span>] <span class="op">$</span></span>
<span id="cb1-293"><a href="#cb1-293" aria-hidden="true" tabindex="-1"></a>          \(<span class="ot">_ ::</span> <span class="dt">Int</span>) <span class="ot">-&gt;</span> hPut hdl (BL.intDec <span class="dv">9</span>)</span>
<span id="cb1-294"><a href="#cb1-294" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span> <span class="op">$</span> <span class="dt">Right</span> ()</span>
<span id="cb1-295"><a href="#cb1-295" aria-hidden="true" tabindex="-1"></a>    lift <span class="op">.</span> lift <span class="op">$</span> threadDelay <span class="dv">1000</span></span>
<span id="cb1-296"><a href="#cb1-296" aria-hidden="true" tabindex="-1"></a>    im <span class="ot">&lt;-</span> <span class="dt">ExceptT</span> <span class="op">$</span> <span class="dt">Right</span> <span class="op">&lt;$&gt;</span> newEmptyHandleManager</span>
<span id="cb1-297"><a href="#cb1-297" aria-hidden="true" tabindex="-1"></a>    wh <span class="ot">&lt;-</span> <span class="dt">ExceptT</span> <span class="op">$</span> <span class="dt">Right</span> <span class="op">&lt;$&gt;</span> openDBFile im [<span class="st">&quot;test.txt&quot;</span>]</span>
<span id="cb1-298"><a href="#cb1-298" aria-hidden="true" tabindex="-1"></a>    forM_ [<span class="dv">1</span><span class="op">..</span><span class="dv">10</span>] <span class="op">$</span> \rId <span class="ot">-&gt;</span> fork <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-299"><a href="#cb1-299" aria-hidden="true" tabindex="-1"></a>        h1  <span class="ot">&lt;-</span> <span class="dt">ExceptT</span> <span class="op">$</span> <span class="dt">Right</span> <span class="op">&lt;$&gt;</span> openReadHandle im [<span class="st">&quot;test.txt&quot;</span>]</span>
<span id="cb1-300"><a href="#cb1-300" aria-hidden="true" tabindex="-1"></a>        forM_ [<span class="dv">1</span> <span class="op">..</span> <span class="dv">50</span>] <span class="op">$</span> \(<span class="ot">_ ::</span> <span class="dt">Int</span>) <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb1-301"><a href="#cb1-301" aria-hidden="true" tabindex="-1"></a>            x1  <span class="ot">&lt;-</span> <span class="dt">ExceptT</span> <span class="op">$</span> readFromHandle im h1 <span class="dv">1</span></span>
<span id="cb1-302"><a href="#cb1-302" aria-hidden="true" tabindex="-1"></a>            ()  <span class="ot">&lt;-</span> atomically <span class="op">$</span> takeTMVar loggerLock</span>
<span id="cb1-303"><a href="#cb1-303" aria-hidden="true" tabindex="-1"></a>            lift <span class="op">.</span> lift <span class="op">$</span></span>
<span id="cb1-304"><a href="#cb1-304" aria-hidden="true" tabindex="-1"></a>                say <span class="op">$</span> <span class="st">&quot;R(&quot;</span> <span class="op">&lt;&gt;</span> <span class="fu">show</span> (<span class="ot">rId ::</span> <span class="dt">Int</span>) <span class="op">&lt;&gt;</span> <span class="st">&quot;) = &quot;</span> <span class="op">&lt;&gt;</span> C8.unpack x1</span>
<span id="cb1-305"><a href="#cb1-305" aria-hidden="true" tabindex="-1"></a>            atomically <span class="op">$</span> putTMVar loggerLock ()</span>
<span id="cb1-306"><a href="#cb1-306" aria-hidden="true" tabindex="-1"></a>            lift <span class="op">.</span> lift <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-307"><a href="#cb1-307" aria-hidden="true" tabindex="-1"></a>                delay <span class="ot">&lt;-</span> randomRIO (<span class="dv">100</span><span class="ot"> ::</span> <span class="dt">Int</span>, <span class="dv">1000</span>)</span>
<span id="cb1-308"><a href="#cb1-308" aria-hidden="true" tabindex="-1"></a>                threadDelay delay</span>
<span id="cb1-309"><a href="#cb1-309" aria-hidden="true" tabindex="-1"></a>    fork <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-310"><a href="#cb1-310" aria-hidden="true" tabindex="-1"></a>        forM_ [<span class="dv">1</span> <span class="op">..</span> <span class="dv">10</span>] <span class="op">$</span> \i <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb1-311"><a href="#cb1-311" aria-hidden="true" tabindex="-1"></a>            bWritten <span class="ot">&lt;-</span> <span class="dt">ExceptT</span> <span class="op">$</span> writeToHandle im wh (BL.intDec i)</span>
<span id="cb1-312"><a href="#cb1-312" aria-hidden="true" tabindex="-1"></a>            ()  <span class="ot">&lt;-</span> atomically <span class="op">$</span> takeTMVar loggerLock</span>
<span id="cb1-313"><a href="#cb1-313" aria-hidden="true" tabindex="-1"></a>            lift <span class="op">.</span> lift <span class="op">$</span> say <span class="op">$</span> <span class="st">&quot;W(&quot;</span> <span class="op">&lt;&gt;</span> <span class="fu">show</span> i <span class="op">&lt;&gt;</span> <span class="st">&quot;) = &quot;</span> <span class="op">&lt;&gt;</span> <span class="fu">show</span> bWritten</span>
<span id="cb1-314"><a href="#cb1-314" aria-hidden="true" tabindex="-1"></a>            atomically <span class="op">$</span> putTMVar loggerLock ()</span>
<span id="cb1-315"><a href="#cb1-315" aria-hidden="true" tabindex="-1"></a>            lift <span class="op">.</span> lift <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-316"><a href="#cb1-316" aria-hidden="true" tabindex="-1"></a>                delay <span class="ot">&lt;-</span> randomRIO (<span class="dv">100</span>, <span class="dv">1000</span>)</span>
<span id="cb1-317"><a href="#cb1-317" aria-hidden="true" tabindex="-1"></a>                threadDelay delay</span>
<span id="cb1-318"><a href="#cb1-318" aria-hidden="true" tabindex="-1"></a>    lift <span class="op">.</span> lift <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-319"><a href="#cb1-319" aria-hidden="true" tabindex="-1"></a>        threadDelay (<span class="dv">8</span> <span class="op">*</span> <span class="dv">1000000</span>)</span>
<span id="cb1-320"><a href="#cb1-320" aria-hidden="true" tabindex="-1"></a>        say <span class="st">&quot;Closing the DB..&quot;</span></span>
<span id="cb1-321"><a href="#cb1-321" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ExceptT</span> <span class="op">$</span> closeDBFile im [<span class="st">&quot;test.txt&quot;</span>]</span>
<span id="cb1-322"><a href="#cb1-322" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ExceptT</span> <span class="op">$</span> <span class="dt">Right</span> <span class="op">&lt;$&gt;</span> closeHandleManager im</span>
<span id="cb1-323"><a href="#cb1-323" aria-hidden="true" tabindex="-1"></a>    lift <span class="op">.</span> lift <span class="op">$</span> say <span class="st">&quot;Done&quot;</span></span></code></pre></div>


<hr>
Loved this post? Stay <a href="http://www.alfredodinapoli.com/rss.xml">update</a>!
<h2><u>Comments</u></h2>
<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_identifier = '/drafts/2018-12-24-multiple-concurrent-readers-in-haskell.html';
  var disqus_url = 'http://www.alfredodinapoli.com' + '/drafts/2018-12-24-multiple-concurrent-readers-in-haskell.html';
  var disqus_title = 'Multiple concurrent file readers in Haskell';
  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = 'http://adinapoli.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
   })();
</script>
 <noscript><p>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=adinapoli">comments powered by Disqus.</a></p></noscript>





          <!-- end of content -->
      </div>
    
    <!-- end of main container -->
    </div>
    
      
    

  </body>
</html>
