<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" content="text/html" http-equiv="content-type" />
    <meta content="Alfredo Di Napoli - Computer Scientist, Scala and Haskell Programmer" name="title" />
    <meta content="Alfredo Di Napoli - Computer Scientist, Scala and Haskell Programmer" name="description" />
    <meta content="Alfredo Di Napoli, Di Napoli Alfredo, Haskell, C++, Python, Scala
    Programmer, Engineer, Functional, Programmatore, Roma, Web" name="keywords" />
    <meta content="alfredo.dinapoli@gmail.com" name="Author" /><meta content="global" name="distribution" />
    <meta content="document" name="resource-type" /><meta content="Alfredo Di Napoli" name="CreatedBy" />
    <meta content="General" name="RATING" />
    <meta content="all,index,follow" name="ROBOTS" />
    <meta content="15 days" name="REVISIT-AFTER" />
    <meta content="Public" name="document-type" />
    <meta content="Safe for Kids" name="document-rating" />
    <meta content="Global" name="document-distribution" />
    <meta content="internet" name="document-classification" />
    <meta content="Alfredo Di Napoli - Computer Scientist, Scala and Haskell Programmer" name="abstract" />
    <meta content="en" http-equiv="content-language" />
    <meta content="Aladin" name="robots" />
    <meta content="scooter" name="robots" />
    <meta content="Crawler" name="robots" />
    <meta content="Eule-Robot" name="robots" />
    <meta content="excite" name="robots" />
    <meta content="Flipper/1.1" name="robots" />
    <meta content="SmartCrawl" name="robots" />
    <meta content="Motor0.5" name="robots" />
    <meta content="Lycos" name="robots" />
    <meta content="Google" name="robots" />
    <meta content="Bing" name="robots" />
    <meta content="Copyright &copy; Alfredo Di Napoli - All rights reserved" name="copyright" />
    <meta content="web design, functional, haskell, scala, python, programming" name="classification" />
    <meta content="GLOBAL" name="distribution" />

    <title>Alfredo Di Napoli - Computer Scientist, Scala and Haskell Programmer</title>
    <link href="../css/bootstrap.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="../css/syntax.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="../css/screen.css" rel="stylesheet" type="text/css" media="screen" />
    
  </head>

  <body>
    <div class="container">
      
      <!-- start header -->
      <div id="header" class="row">

        <div class="col-5">
          <div class="col-7">
            <em class="lead">Simplicity is the ultimate sophistication.</em>
          </div>

          <div class="col-5 pull-left">
            <img src="../img/enso.png" width="100" />
          </div>
        </div>
        
        <div class="col-7">
          <div id="menu" class="pull-right">
            <a href="../index.html">Home</a> ●
            <a href="../posts.html">Blog</a> ●
            <a href="../oss.html">Projects</a> ●
            <a href="../talks.html">Talks</a> ●
            <a href="../cv_eu/cv_eu.html">CV</a> ●
            <a href="../contacts.html">Contacts</a>
          </div>
        </div>

      </div>

      <!-- end header -->
      <div class="row">
        <hr>
          <!-- content goes here -->
          <script type="text/javascript">
  var disqus_developer = 1;
</script>


<h1>How to backup and store your GPG private key (semi) securely</h1>

<p>Posted in: <a title="All pages tagged 'linux'." href="../tags/linux.html">linux</a>, <a title="All pages tagged 'security'." href="../tags/security.html">security</a>.</p>
<br>
<pre><code>Summary: splitting your key into multiple pieces and do something different with each piece is a not-too-shabby way to secure your GPG private key.</code></pre>
<p><strong>Disclaimer: I am not a security expert, and there is no such thing as “perfect security”, thus the witty title of my blog post. You are encouraged to try out what I am describing here, but I am not responsible for any misuse or data loss occurring while trying out the steps below.</strong></p>
<p>I am guilty of discovering the power and versatility of GPG keys only in my late 30s (I know, I know). It happened by pure chance as it was a required step for my previous job. It’s a really nice way to bind and verify digital identities to some random bits sitting in your computer. Plus, it opens up new exciting possibilities, like securing all your passwords with something like <a href="https://www.passwordstore.org/">pass</a>. However, this has the (expected) consequence that now your GPG key becomes a single point of failure and if it gets lost or, worse, stolen, it can be quite a disaster.</p>
<p>To mitigate this, saving it somewhere safe is paramount. This begs the question: “how?”. I usually have (enough but not too much) trust in cloud providers like Dropbox, Google Drive &amp; co, but ultimately you are sending your precious data over the network (hoping the connection is secure and the traffic not spoofed) and if one of these services gets compromised, the integrity and security of your data also is.</p>
<p>To mitigate this, I have been researching ways of securely storing my private GPG key, and I think what I came up with is decent (at least for my use case).</p>
<h3 id="first-attempt">First attempt</h3>
<p>My first attempt was - as suggested around - to use something like <code>qrencode</code> to turn my GPG key into a QR code I could then print and store in a closet. Then I could use something like <a href="http://manpages.ubuntu.com/manpages/bionic/man1/zbarimg.1.html">zbarimg</a> to retrive my key. However, this approach releaved to be not practical as my key is too big and it doesn’t fit into a QR code.</p>
<h3 id="the-final-solution">The final solution</h3>
<p>I ended up splitting my key into 4 parts, and I have <em>then encoded as a QR code only the first part</em>; the other three have been encrypted with a symmetric key (i.e. <code>gpg -c your-file</code>). By doing that, I can store the encrypted parts inside Dropbox, and print the first part and store it physically in a safe place.</p>
<h3 id="why">Why?</h3>
<p>That’s a fair question; in principle, simply encrypting my GPG key with a symmetric key and upload it to Dropbox might have been enough, but I feel like this schema opens up more possibilities. I especially like the fact I am not dependant on just one cloud provider and that, even if Dropbox is ever compromised, and even if by some quantum-computer-miracle my symmetric key is bruteforced, the attacker would still miss the last piece of the puzzle (no pun intended).</p>
<p>Last but not least, here I have only used a single symmetric key for all the three parts of my key, but nobody is preventing me from using two or even three different ones. This way, even if one symmetric key is leaked somehow, the attacker couldn’t still have access to my full GPG key (provided he could get his hands on the QR code, of course).</p>
<h3 id="the-scripts">The scripts</h3>
<p>I have two scripts that I have whipped up: the first one exports my GPG key and split it into chunks:</p>
<pre><code>#!/usr/bin/env bash

# First export your gpg key like so:
#
# gpg --export-secret-keys -a -o mykey.asc
#
# Then this script will generate 4 qr codes for your key. At this point
# it's up to you what to do with these images.

split -b 2800 $1 mykey-

for file in mykey-??; do
    &lt;&quot;$file&quot; qrencode -o &quot;$file&quot;.png
done</code></pre>
<p>Running this script giving as input the filename of your exported key would first split it into multiple parts and finally for each of them run <code>qrencode</code>. At this point you would be left with an <code>.asc</code> file (which you might want to delete now) and a bunch of files like, for example:</p>
<pre><code>mykey-aa
mykey-aa.png
mykey-ab
mykey-ab.png
...</code></pre>
<p>At this point you can delete all the <code>.png</code> but the first one, and conversely delete the first <code>mykey-aa</code> keeping the other around. Now, for each of the “chunks” (except the one and only <code>.png</code>, of course) proceed to the gpg encryption with a symmetric key of your choice. For example:</p>
<pre><code>gpg -c mykey-ab</code></pre>
<p>This will spawn pinetry and allow you to insert the password. At the end of this operation, you should have multiple <code>.gpg</code> files: these are the ones you can store on Dropbox. Your files should be looking somewhat like this:</p>
<pre><code>mykey-aa.png
mykey-ab.gpg
mykey-ac.gpg
mykey-ad.gpg</code></pre>
<h4 id="reconstructing-the-key">Reconstructing the key</h4>
<p>Once the time will come to reconstruct your key, you can use this other script:</p>
<pre><code>#!/usr/bin/env bash

RESULT=mykey.asc

zbarimg --raw $1-aa.png | perl -pe 'chomp if eof' - &gt; $RESULT

for f in $1-ab.gpg $1-ac.gpg $1-ad.gpg; do
  echo $f;
  gpg -dq $f &gt;&gt; $RESULT;
done

# Sanity check
gpg --dearmor $RESULT &gt;/dev/null</code></pre>
<p>You have to supply to this script the <code>basename</code> of your files (in our example would be <code>mykey</code>) and the script would first read the QR code, then decrypt the other chunks (in my case they are just 3 and are hardcoded in the script, your mileage might vary) and <em>dulcis in fundo</em> it will perform a sanity check on the reconstructed key.</p>
<p>Voilà, your key has been reconstructed! You can now import the key again inside your GPG keychain by doing <code>gpg --import &lt;key&gt;</code>.</p>
<p>I have tested this approach myself when migrating the key from a laptop to another and it worked just fine, so hopefully this will be useful to you as well.</p>
<h2 id="update-2018-12-23-a-possible-improvement">(Update 2018-12-23) A possible improvement</h2>
<p>My friend Edsko pointed out a few quirks in my original scheme. In particular, assuming the possibility that Dropbox can actually be violated and that the last piece of the puzzle standing between the full key is the QR code, using the first chunk as our unencrypted QR code is a poor choice. First of all, we are still subject to bruteforce attacks as now all it takes for the attacker to get knowledge of the key is to bruteforce 1/4 of it. Not only that, but crucially the first part of the key includes a few bytes for the header (the <code>-----BEGIN PGPG PRIVATE KEY BLOCK-----</code>) which means there are actually even fewer bytes to bruteforce.</p>
<p><em>A better scheme</em> here would be to:</p>
<ul>
<li>Encrypt with a symmetric key <em>all</em> the chunks;</li>
<li>Turn into QR codes the chunks <em>in the middle</em>.</li>
</ul>
<p>This way, we are not only eliminating the problem of the header, but also never storing something unencrypted. The obvious consequence is that now we need an extra step to recover our key.</p>
<h2 id="other-alternatives">Other alternatives</h2>
<p>Somebody also suggested to use something like <a href="https://github.com/Rupan/paperbak">paperbak</a>, which is ultimately possible but I was put off by what seemed to be quite a careful procedure for restoring the data from the printed bitmap. In particular the readme explains how is important to have a good printer etc etc, so I didn’t want to take the risk.</p>


<hr>
Loved this post? Stay <a href="http://www.alfredodinapoli.com/rss.xml">update</a>!
<h2><u>Comments</u></h2>
<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_identifier = '/posts/2018-12-20-semi-secure-gpg-key-backup.html';
  var disqus_url = 'http://www.alfredodinapoli.com' + '/posts/2018-12-20-semi-secure-gpg-key-backup.html';
  var disqus_title = 'How to backup and store your GPG private key (semi) securely';
  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = 'http://adinapoli.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
   })();
</script>
 <noscript><p>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=adinapoli">comments powered by Disqus.</a></p></noscript>





          <!-- end of content -->
      </div>
    
    <!-- end of main container -->
    </div>
    
      
    

  </body>
</html>
